<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" integrity="sha512-mSYUmp1HYZDFaVKK//63EcZq4iFWFjxSL+Z3T/aCt4IO9Cejm03q3NKKYN6pFQzY0SBOr8h+eCIAZHPXcpZaNw=="
        crossorigin="anonymous" />
    <title>Document</title>
    <style>
        body {
            min-height: 100vh;

            /* background-image: linear-gradient(to right bottom, #0363dd, #7d66dd, #b36ad8, #dd72d1, #fd7fc9); */
            font-family: 'Prompt', sans-serif;
        }
    </style>
</head>

<body>
    <img src="https://www.img.in.th/images/ea3c8ab216e679dec9fde09be6033712.png" alt="banner" class="img-fluid" width="100%">

    <div class="container-fluid">
        <form id="main-form" class="mb-5 needs-validation" novalidate>
            <p class="display-6 m-3">
                แบบฟอร์มรับสมัครเรียน
            </p>
            <div class="row justify-content-start align-items-start">
                <div class="col-sm-4 mt-3">
                    <label for="prename">คำนำหน้าชื่อ</label>
                    <select type="text" class="form-control" name="prename" id="prename" placeholder="คำนำหน้าชื่อ" required>
                        <option value="" disabled selected>คำนำหน้าชื่อ</option>
                        <option value="เด็กชาย">เด็กชาย</option>
                        <option value="เด็กหญิง">เด็กหญิง</option>
                        <option value="นาย">นาย</option>
                        <option value="นาง">นาง</option>
                        <option value="นางสาว">นางสาว</option>
                    </select>
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="firstname">ชื่อ</label>
                    <input type="text" class="form-control" name="firstname" id="firstname" placeholder="ชื่อ" required>
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="lastname">นามสกุล</label>
                    <input type="text" class="form-control" name="lastname" id="lastname" placeholder="นามสกุล" required>
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="nickname">ชื่อเล่น</label>
                    <input type="text" class="form-control" name="nickname" id="nickname" placeholder="ชื่อเล่น" required>
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="birthdate">วันเดือนปีเกิด (พ.ศ.)</label>
                    <input type="text" class="form-control date" id="birthdate" name="birthdate" placeholder="วันเดือนปี" required />
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="age">อายุ</label>
                    <input type="text" class="form-control" id="age" name="age" placeholder="อายุ" required readonly />
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="phone">เบอร์ติดต่อ</label>
                    <input type="text" class="form-control" name="phone" id="phone" placeholder="เบอร์ติดต่อ">
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="email">อีเมลผู้สมัคร</label>
                    <input type="text" class="form-control" id="email" name="email" placeholder="อีเมลผู้สมัคร" required />
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="lineid">Line ID ผู้สมัคร</label>
                    <input type="text" class="form-control" id="lineid" name="lineid" placeholder="Line ID ผู้สมัคร" required />
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="select_class">หลักสูตรที่ลงทะเบียนเรียน</label>
                    <select type="text" class="form-select" id="select_class" name="select_class" required>
                        <option value="" disabled selected>หลักสูตรที่ลงทะเบียนเรียน</option>
                    </select>
                </div>
            </div>
            <div class="row justify-content-start align-items-start" id="parent-row" style="display: none;">
                <div class="col-12 mt-3">
                    <p class="text-danger">สำหรับผูัสมัครอายุไม่ถึง 18 ปี</p>
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="parent_name">ชื่อ-นามสกุลผู้ปกครอง</label>
                    <input type="text" class="form-control" name="parent_name" id="parent_name" placeholder="ชื่อ-นามสกุลผู้ปกครอง">
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="relation">ความเกี่ยวข้องกับผู้เรียน</label>
                    <input type="text" class="form-control" name="relation" id="relation" placeholder="ความเกี่ยวข้องกับผู้เรียน">
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="parent_phone">เบอร์ติดต่อ</label>
                    <input type="text" class="form-control" name="parent_phone" id="parent_phone" placeholder="เบอร์ติดต่อ">
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="occupation">อาชีพผู้ปกครอง</label>
                    <input type="text" class="form-control" id="occupation" name="occupation" placeholder="อาชีพผู้ปกครอง" />
                </div>

                <div class="col-sm-4 mt-3">
                    <label for="parent_email">อีเมลผู้ปกครอง</label>
                    <input type="text" class="form-control" id="parent_email" name="parent_email" placeholder="อีเมลผู้ปกครอง" />
                </div>
                <div class="col-sm-4 mt-3">
                    <label for="parent_lineid">Line ID ผู้ปกครอง</label>
                    <input type="text" class="form-control" id="parent_lineid" name="parent_lineid" placeholder="Line ID ผู้ปกครอง" />
                </div>
                <div class="col-sm-6 mt-3">
                    <label for="address">ที่อยู่ที่ติดต่อได้</label>
                    <textarea class="form-control" id="address" name="address" placeholder="ที่อยู่ที่ติดต่อได้" rows="3"></textarea>
                </div>

            </div>
            <div class="row">
                <div class="col-sm-6 mt-3">
                    <label for="file">หลักฐานการชำระเงินลงทะเบียน</label>
                    <input type="file" name="file" id="file" class="form-control" required>
                </div>
            </div>
            <div class="row ">
                <div class="col-sm-4 mt-3 mb-5">
                    <button class="btn btn-primary">ลงทะเบียน</button>
                </div>
            </div>
        </form>
        <section id="success-sec" style="display: none;">
            <div class="row justify-content-center mt-3">
                <div class="col-12 text-center mt-3">
                    ชื่อ&nbsp;<span id="success-name" class="text-success">xxxxxxxx</span>
                </div>
                <div class="col-12 text-center mt-3">
                    หลักสูตรที่ลงทะเบียนเรียน&nbsp;<span id="success-class" class="text-success">xxxxxxxx</span>
                </div>
                <div class="col-12 text-center mt-3">
                    รหัสประจำตัวผู้เรียน&nbsp;<span id="success-id" class="text-success">xxxxxxxx</span>
                </div>
                <div class="col-12 text-center mt-3">
                    หลักฐานการชำระเงินลงทะเบียน
                </div>
                <div class="col-12 text-center">
                    <img alt="" class="img-fluid" id="preview">
                </div>
            </div>
        </section>
    </div>

    <script>
        var scriptUrl = 'https://script.google.com/macros/s/AKfycbz2SqR1f6GZ3OsRuCQY_XBoQeJFOqPI4lB0I-E-naDha91d78G7ITWo3fG2JCowE7eW/exec'
        

        $(document).ready(function () {
            $.LoadingOverlay("show", {
                background: "rgba(3, 95, 221, 0.5)"
            });
            $('.date').datepicker({
                format: 'd/m/yyyy',
                autoclose: true,
                todayHighlight: true,
                language: 'th',
                // startDate: '1900-01-01',
                // endDate: '2020-12-31'
            });

            $('form').find('input, select, textarea').each(function () {
                let label = $(this).prev('label').text()
                $(this).closest('.col-sm-4').append($('<div>', { class: 'invalid-feedback', text: 'กรุณาใส่' + label }))
            });

            $.getJSON(scriptUrl + '?opt=getclass', function (data) {
                Object.keys(data).forEach(function (key) {
                    $('#select_class').append($('<optgroup>', {
                        label: key,
                        id: key
                    }));
                    data[key].forEach(function (value) {
                        $('#select_class optgroup[id="'+key+'"]').append($('<option>', {
                            value: value,
                            text: value
                        }));
                    });
                });
                $.LoadingOverlay("hide");
            });

        });
        (function () {
            "use strict";
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.querySelectorAll(".needs-validation");
            // Loop over them and prevent submission
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener(
                    "submit",
                    function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                            $(form).find(":invalid").first().focus();
                        } else formsubmit();
                        form.classList.add("was-validated");
                    },
                    false
                );
            });
        })();
    </script>
    <script>
        $('#birthdate').on('change', function () {
            var birthdate = $('#birthdate').val();
            var age = getAge(birthdate);
            $('#age').val(age);

            if (age < 18) {
                $('#parent_name').attr('required', true);
                $('#parent_phone').attr('required', true);
                $('#occupation').attr('required', true);
                $('#address').attr('required', true);
                $('#parent_email').attr('required', true);
                $('#parent_lineid').attr('required', true);
                $('#parent-row').slideDown(200);
            } else {
                $('#parent_name').attr('required', false);
                $('#parent_phone').attr('required', false);
                $('#occupation').attr('required', false);
                $('#address').attr('required', false);
                $('#parent_email').attr('required', false);
                $('#parent_lineid').attr('required', false);
                $('#parent-row').slideUp(200);
            }
        });

        var img = {}
        $('#file').on('change', function () {
            if (this.files[0].length == 0) return
            img = {}
            let file = this.files[0];
            let reader = new FileReader();
            reader.onloadend = function (e) {
                img.data = e.target.result;
                img.name = file.name;
            }
            reader.readAsDataURL(file);
        });


    </script>
    <script>
        function getAge(birthdate) {
            let today = new Date();
            today.setFullYear(today.getFullYear() + 543);
            let birthDate = moment(birthdate, 'D/M/YYYY').toDate()
            let age = today.getFullYear() - birthDate.getFullYear();
            return age
        }

        function formsubmit() {
            event.preventDefault()
            let form = $('#main-form')
            let formData = form.serializeArray()
            let data = {}
            formData.forEach(function (item) {
                data[item.name] = item.value
            })
            data.img = JSON.stringify(img)
            $.LoadingOverlay("show", {
                background: "rgba(253, 127, 200, 0.5)"
            });
            $.post(scriptUrl + '?opt=register', data, function (res) {
                $.LoadingOverlay("hide");
                if (res.status == 'success') {
                    Swal.fire({
                        title: 'สำเร็จ',
                        text: 'ลงทะเบียนสำเร็จ',
                        icon: 'success',
                        confirmButtonText: 'ตกลง'
                    }).then(function () {
                        $('#main-form').slideUp()
                        $('#success-sec').slideDown()
                        $('#success-name').text(`${data.prename}${data.firstname} ${data.lastname}`)
                        $('#success-class').text(data.class)
                        $('#success-id').text(res.id)
                        $('#preview').attr('src', img.data)
                    })
                } else {
                    Swal.fire({
                        title: 'ผิดพลาด',
                        text: res.message,
                        icon: 'error',
                        confirmButtonText: 'ตกลง'
                    })
                }
            })
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js" integrity="sha512-T/tUfKSV1bihCnd+MxKD0Hm1uBBroVYBOYSk1knyvQ9VyZJpc/ALb4P0r6ubwVPSGB2GvjeoMAJJImBG12TiaQ=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.th.min.js" integrity="sha512-cp+S0Bkyv7xKBSbmjJR0K7va0cor7vHYhETzm2Jy//ZTQDUvugH/byC4eWuTii9o5HN9msulx2zqhEXWau20Dg=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.nl-BE.min.js" integrity="sha512-N6RmlYMwJ5Fj9RqeBmDhzEG8hlmuT0DqjiMJpuUsMlwhkJvNf55+MPdV2BHlNWDCG2z+nbpr6fAg9oChjPkX9g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script>
        ; (function ($) {
            if (typeof $.fn.datepicker === 'undefined') {
                throw new Error('Load bootstrap-datepicker first !!!');
            }
            var DPGlobal = $.fn.datepicker.DPGlobal
                , adjYear = 543
                , currentYear = new Date().getFullYear();
            // Transform to BE for display
            function toBEYear(year) {
                var beBound = currentYear + (adjYear / 2);
                if (year >= beBound) {
                    year -= adjYear;
                }
                if (year < beBound) {
                    year += adjYear;
                }
                return year;
            }
            // Transform to CE for calculate
            function toCEYear(year) {
                var beBound = currentYear + (adjYear / 2);
                if (year >= beBound) {
                    year -= adjYear;
                }
                return year;
            }
            // Inherit DPGlobal from bootstrap-datepicker
            var _parentDPGlobal_ = $.extend({}, DPGlobal);
            $.extend(DPGlobal, {
                parseDate: function (date, format, language, assumeNearby) {
                    var formats = format
                        , parts = date && date.match(this.nonpunctuation) || [];
                    if (typeof formats === 'string') {
                        formats = DPGlobal.parseFormat(format);
                    }
                    if (parts.length == formats.parts.length) {
                        var separators = $.extend([], formats.separators)
                            , modDate = [];
                        for (var i = 0, cnt = formats.parts.length; i < cnt; i++) {
                            if (~['yyyy', 'yy'].indexOf(formats.parts[i])) {
                                parts[i] = '' + toCEYear(parseInt(parts[i], 10));
                            }
                            if (separators.length) {
                                modDate.push(separators.shift());
                            }
                            modDate.push(parts[i])
                        }
                        date = modDate.join('');
                        return _parentDPGlobal_.parseDate.call(this, date, format, language, assumeNearby);
                    }
                },
                formatDate: function (date, format, language) {
                    var childFormatDate = _parentDPGlobal_.formatDate.call(this, date, format, language);
                    var formats = format
                        , parts = childFormatDate && childFormatDate.match(this.nonpunctuation) || []
                        , trnfrm = {
                            yy: toBEYear(date.getUTCFullYear()).toString().substring(2)
                            , yyyy: toBEYear(date.getUTCFullYear()).toString()
                        };
                    if (typeof formats === 'string') {
                        formats = DPGlobal.parseFormat(format);
                    }
                    if (parts.length == formats.parts.length) {
                        var separators = $.extend([], formats.separators)
                            , modDate = [];
                        for (var i = 0, cnt = formats.parts.length; i < cnt; i++) {
                            if (separators.length) {
                                modDate.push(separators.shift())
                            }
                            modDate.push(trnfrm[formats.parts[i]] || parts[i])
                        }
                        childFormatDate = modDate.join('')
                    }
                    return childFormatDate;
                }
            });
            // Inherit DatePicker from bootstrap-datepicker
            var DatePicker = $.fn.datepicker.Constructor;
            var _parentDatePicker_ = $.extend({}, DatePicker.prototype);
            $.extend(DatePicker.prototype, {
                fill: function () {
                    var d = new Date(this.viewDate);
                    this.viewDate.setUTCFullYear(toCEYear(d.getUTCFullYear()));
                    _parentDatePicker_.fill.call(this);
                    var yearTitle = this.picker.find('.datepicker-months')
                        .find('.datepicker-switch');
                    if (parseInt(yearTitle.text()) > 1000) {
                        yearTitle.text(
                            toBEYear(parseInt(yearTitle.text()))
                        );
                    }
                },
                _fill_yearsView: function (selector, cssClass, factor, step, currentYear, startYear, endYear, callback) {
                    currentYear = toBEYear(currentYear);
                    startYear = toBEYear(startYear);
                    endYear = toBEYear(endYear);
                    _parentDatePicker_._fill_yearsView.call(this, selector, cssClass, factor, step, currentYear, startYear, endYear, callback);
                }
            });
        }(jQuery));
    </script>
</body>

</html>
